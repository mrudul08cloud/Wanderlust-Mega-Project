name: DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

jobs:

  # -------------------- 1. SONAR SCAN --------------------
  sonar_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=wanderlust
            -Dsonar.projectName=wanderlust
            -Dsonar.sources=.

      - name: Upload Sonar Metadata
        uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: .scannerwork/report-task.txt

  # -------------------- 2. QUALITY GATE CHECK --------------------
  quality_gate:
    runs-on: ubuntu-latest
    needs: sonar_scan

    steps:
      - name: Download Sonar Metadata
        uses: actions/download-artifact@v4
        with:
          name: sonar-report
          path: .scannerwork/

      - name: Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt
          pollingTimeoutSec: 300

  # -------------------- 3. OWASP DEPENDENCY CHECK --------------------
  dependency_check:
    runs-on: ubuntu-latest
    needs: quality_gate

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: wanderlust
          path: .
          format: HTML
          out: reports

      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/

  # -------------------- 4. TRIVY SCAN --------------------
  trivy_scan:
    runs-on: ubuntu-latest
    needs: dependency_check

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.48.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.48.0_Linux-64bit.deb

      - name: Trivy FileSystem Scan
        run: |
          trivy fs . \
            --format table \
            --output trivy-fs-report.txt || true

      - name: Upload Trivy FS Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: trivy-fs-report.txt

      # Optional Docker image scan
      - name: Build Docker Image
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: docker build -t wandertemp .

      - name: Trivy Image Scan
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: |
          trivy image wandertemp \
            --format table \
            --output trivy-image-report.txt || true

      - name: Upload Trivy Image Report
        if: ${{ hashFiles('Dockerfile') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.txt

  # -------------------- 5. DEPLOY USING DOCKER COMPOSE --------------------
  deploy:
    runs-on: self-hosted
    needs: trivy_scan

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          docker-compose down || true
          docker-compose up -d --build
